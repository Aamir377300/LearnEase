name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # CI: Test Backend
  test-backend:
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install backend dependencies
        working-directory: ./server
        run: npm install
      
      - name: Run backend tests
        working-directory: ./server
        run: npm test
        env:
          JWT_SECRET: test_secret
          MONGODB_URI: mongodb://localhost:27017/test
      
      - name: ‚ùå Tests Failed - Deployment Blocked
        if: failure()
        run: |
          echo "::error::Backend tests failed! Deployment blocked."
          echo "Previous version remains live. Fix the errors and push again."
          exit 1

  # CI: Test and Build Frontend
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install frontend dependencies
        working-directory: ./client
        run: npm install
      
      - name: Lint frontend
        working-directory: ./client
        run: npm run lint || echo "Linting completed with warnings"
      
      - name: Build frontend
        working-directory: ./client
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:5002' }}
      
      - name: ‚ùå Build Failed - Deployment Blocked
        if: failure()
        run: |
          echo "::error::Frontend build failed! Deployment blocked."
          echo "Previous version remains live. Fix the errors and push again."
          exit 1

  # CD: Deploy Backend to Render (only if ALL tests pass)
  deploy-backend:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üöÄ Deploy to Render
        run: |
          echo "Deploying backend to Render..."
          if [ -z "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}" ]; then
            echo "::warning::RENDER_BACKEND_DEPLOY_HOOK not configured. Skipping backend deployment."
            echo "Follow CI-CD-SETUP.md to configure Render deployment."
            exit 0
          fi
          curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}"
      
      - name: ‚è≥ Wait for deployment
        if: ${{ secrets.RENDER_BACKEND_DEPLOY_HOOK != '' }}
        run: sleep 30
      
      - name: ‚úÖ Check backend health
        if: ${{ secrets.BACKEND_URL != '' }}
        run: |
          echo "Checking backend health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Backend deployed successfully!"
          else
            echo "::error::Backend health check failed! Status: $response"
            echo "::error::Deployment may have failed. Previous version should still be running."
            exit 1
          fi
      
      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "::error::Backend deployment failed!"
          echo "Previous version remains live on Render."
          echo "Check Render logs for details."

  # CD: Deploy Frontend to Vercel (only if ALL tests pass)
  deploy-frontend:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: üöÄ Deploy to Vercel
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "::warning::VERCEL_TOKEN not configured. Skipping frontend deployment."
            echo "Follow CI-CD-SETUP.md to configure Vercel deployment."
            exit 0
          fi
          echo "Deploying frontend to Vercel..."
          npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        working-directory: ./client
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID || secrets.VERCEL_PROJECT_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: ‚úÖ Frontend Deployed
        if: success()
        run: echo "‚úÖ Frontend deployed successfully to Vercel!"
      
      - name: ‚ùå Deployment Failed
        if: failure()
        run: |
          echo "::error::Frontend deployment failed!"
          echo "Previous version remains live on Vercel."
          echo "Check Vercel logs for details."

  # Summary
  deployment-summary:
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üìä Deployment Summary
        run: |
          echo "==================================="
          echo "üéâ CI/CD Pipeline Complete!"
          echo "==================================="
          echo "‚úÖ All tests passed"
          echo "‚úÖ Build successful"
          echo "‚úÖ Deployment triggered"
          echo ""
          echo "Your app is live:"
          echo "Backend: ${{ secrets.BACKEND_URL }}"
          echo "Frontend: Check Vercel dashboard"
          echo "==================================="
